<!-- src/app/components/calcular-nomina/calcular-nomina.component.html -->

<div class="menu-toggle" (click)="toggleMenu()">
  <i class="fas fa-bars"></i>
</div>

<aside class="menu-lateral" [class.active]="menuActive">
  <div class="menu-header"><h2>Menú</h2></div>

  <!-- Menú Gerente -->
  <ul class="menu-items" *ngIf="isGerente">
    <li><a routerLink="/dashboard"><i class="fas fa-home"></i> Inicio</a></li>
    <li><a routerLink="/ver-productos-geren"><i class="fas fa-eye"></i> Ver Productos</a></li>
    <li>
      <a (click)="toggleMovimientos()" id="movimientos"><i class="fas fa-exchange-alt"></i> Movimientos</a>
      <ul class="submenu" [class.active]="movimientosActive">
        <li><a routerLink="/entrada-productos"><i class="fas fa-plus"></i> Entrada</a></li>
        <li><a routerLink="/salida-producto"><i class="fas fa-minus"></i> Salida</a></li>
      </ul>
    </li>
    <li><a routerLink="/reporte-ventas"><i class="fas fa-chart-line"></i> Reportes de Ventas</a></li>
    <li>
      <a (click)="toggleNomina()" id="nomina"><i class="fas fa-money-check"></i> Nómina</a>
      <ul class="submenu" [class.active]="nominaActive">
        <li><a routerLink="/bono-extras-nom"><i class="fas fa-gift"></i> Bonos y Extras</a></li>
        <li><a routerLink="/calcular-nomina"><i class="fas fa-calculator"></i> Cálculo Nómina</a></li>
        <li><a routerLink="/descuentos-nom"><i class="fas fa-hand-holding-usd"></i> Descuentos</a></li>
      </ul>
    </li>
    <li><a routerLink="/cuentas-empleadoss"><i class="fas fa-users-cog"></i> Cuentas de Empleados</a></li>    <li><a (click)="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
  </ul>
</aside>

<main class="contenido-principal">
<header class="main-header">
    <h1>CarniTrack</h1>
  </header>
  <section class="formulario-nomina">
    <div class="container-nomina">
      <h2>Cálculo de Nómina por Quincena</h2>

      <div class="form-calculo">
        <div class="filtro-fechas">
          <div class="form-group">
            <label>Empleado:</label>
            <select [(ngModel)]="nomina.empleado_id" (change)="cargarSalarioBase()" required>
              <option value="">Seleccione empleado...</option>
              <option *ngFor="let e of empleados" [value]="e.id">
                {{ e.id }} - {{ e.nombre }} (Salario: ${{ e.salario | number:'1.2-2' }})
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Inicio de Quincena:</label>
            <input type="date" [(ngModel)]="nomina.inicio" required>
          </div>

          <div class="form-group">
            <label>Fin de Quincena:</label>
            <input type="date" [(ngModel)]="nomina.fin" required>
          </div>
        </div>

        <button class="cta-button" (click)="calcularNominaAutomatica()">Calcular Nómina</button>
      </div>

      <!-- RESULTADO -->
      <div class="resultado-nomina" *ngIf="nomina.calculada">
        <h3>Nómina Calculada Automáticamente</h3>
        <div class="detalle">
          <p><strong>Empleado:</strong> {{ nomina.nombre }}</p>
          <p><strong>Periodo:</strong> {{ nomina.inicio | date:'dd/MM/yyyy' }} al {{ nomina.fin | date:'dd/MM/yyyy' }}</p>
          <p><strong>Salario Base:</strong> ${{ nomina.sal_base | number:'1.2-2' }}</p>
          <p><strong>Horas Extras:</strong> {{ nomina.total_hex }} hrs → ${{ nomina.monto_hex | number:'1.2-2' }}</p>
          <p><strong>Bonos:</strong> ${{ nomina.total_bonos | number:'1.2-2' }}</p>
          <p><strong>Descuentos:</strong> ${{ nomina.total_descuentos| number:'1.2-2' }}</p>
          <p class="total"><strong>SALARIO TOTAL A PAGAR:</strong> ${{ nomina.sal_total | number:'1.2-2' }}</p>
        </div>
        <button class="cta-button secondary" (click)="abrirConfirmacionGuardar()">Guardar Nómina Oficial</button>
      </div>

      <!-- TABLA HISTÓRICA -->
      <div class="tabla-nomina" *ngIf="nominasOficiales.length > 0">
        <h3>Nóminas Guardadas</h3>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Empleado</th>
              <th>Periodo</th>
              <th>Salario Base</th>
              <th>Hrs Extras</th>
              <th>Bonos</th>
              <th>Descuentos</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let n of nominasOficiales">
              <td>{{ n.id_nom }}</td>
              <td>{{ n.trabajador?.nom_trb }}</td>
              <td>{{ n.periodo_inicio }} al {{ n.periodo_fin }}</td>
              <td>${{ n.sal_base | number:'1.2-2' }}</td>
              <td>{{ n.total_horas_extras }}</td>
              <td>${{ n.total_bonos | number:'1.2-2' }}</td>
              <td>${{ n.total_descuentos | number:'1.2-2' }}</td>
              <td><strong>${{ n.sal_total | number:'1.2-2' }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
  <!-- MODAL CONFIRMACIÓN -->
<div class="success-modal-overlay" 
     [style.display]="mostrarModalConfirm ? 'flex' : 'none'"
     (click)="cerrarModalConfirm()">
  <div class="success-modal" (click)="$event.stopPropagation()">
    <div class="success-modal-icon warning">
      <i class="fas fa-question"></i>
    </div>
    <h2>¿Guardar nómina oficialmente?</h2>
    <p>Esta acción no se puede deshacer.</p>
    <div class="modal-buttons">
      <button class="btn-cancelar" (click)="cerrarModalConfirm()">Cancelar</button>
      <button class="success-btn" (click)="confirmarAccion()">Sí, guardar</button>
    </div>
  </div>
</div>

<!-- MODAL ÉXITO -->
<div class="success-modal-overlay" 
     [style.display]="mostrarModalExito ? 'flex' : 'none'"
     (click)="cerrarModalExito()">
  <div class="success-modal" (click)="$event.stopPropagation()">
    <div class="success-modal-icon">
      <i class="fas fa-check"></i>
    </div>
    <h2>Nómina guardada correctamente</h2>
    <p>La nómina quedó registrada en el sistema.</p>
    <button class="success-btn" (click)="cerrarModalExito()">Aceptar</button>
  </div>
</div>
</main>